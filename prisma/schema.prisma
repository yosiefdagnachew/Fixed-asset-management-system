generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  // ...existing fields...
  userPermissions   UserPermission[]
  id                  String        @id @default(cuid())
  name                String?
  email               String        @unique
  password            String
  role                Role          @default(USER)
  emailVerified       DateTime?
  image               String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  maintenanceRequests Maintenance[] @relation("MaintenanceRequestedBy")
  managedMaintenance  Maintenance[] @relation("MaintenanceManagedBy")
  transferRequests    Transfer[]    @relation("TransferRequestedBy")
  disposalRequests    Disposal[]    @relation("DisposalRequestedBy")
}

model Asset {
  id                  String         @id @default(cuid())
  name                String
  description         String?
  serialNumber        String         @unique
  purchaseDate        DateTime
  purchasePrice       Float
  currentValue        Float
  status              String         @default("ACTIVE")
  location            String?
  department          String?
  category            String?
  type                String?
  supplier            String?
  warrantyExpiry      DateTime?
  lastMaintenance     DateTime?
  nextMaintenance     DateTime?
  depreciableCost     Float?
  salvageValue        Float?
  usefulLifeMonths    Int?
  depreciationMethod  DepreciationMethod?
  depreciationStartDate DateTime?
  lastAuditDate       DateTime?
  nextAuditDate       DateTime?
  assetDepreciations  AssetDepreciation[]
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  history             AssetHistory[]
  depreciations       Depreciation[]
  disposalRequests    Disposal[]
  documents           Document[]
  maintenanceRequests Maintenance[]
  transferRequests    Transfer[]
  linkedTo            LinkedAsset[]  @relation("LinkedToAsset")
  linkedFrom          LinkedAsset[]  @relation("LinkedFromAsset")
  capitalImprovements CapitalImprovement[]
  audits              AssetAudit[]
}

model Transfer {
  id             String         @id @default(cuid())
  assetId        String
  reason         String
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  fromDepartment String
  requesterId    String
  toDepartment   String
  status         TransferStatus @default(PENDING)
  asset          Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  requester      User           @relation("TransferRequestedBy", fields: [requesterId], references: [id])
}

model Maintenance {
  id           String              @id @default(cuid())
  assetId      String
  description  String
  cost         Float?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  completedAt  DateTime?
  scheduledDate DateTime?
  priority     MaintenancePriority
  requesterId  String
  managerId    String?
  status       MaintenanceStatus   @default(PENDING_APPROVAL)
  notes        String?
  asset        Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)
  requester    User                @relation("MaintenanceRequestedBy", fields: [requesterId], references: [id])
  manager      User?               @relation("MaintenanceManagedBy", fields: [managerId], references: [id])

  @@index([managerId])
}

model Disposal {
  id            String         @id @default(cuid())
  assetId       String
  reason        String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  actualValue   Float?
  expectedValue Float
  requesterId   String
  method        DisposalMethod
  status        DisposalStatus @default(PENDING)
  asset         Asset          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  requester     User           @relation("DisposalRequestedBy", fields: [requesterId], references: [id])
}

model Document {
  id        String       @id @default(cuid())
  assetId   String
  type      DocumentType
  url       String
  fileName  String?      // Original file name
  fileSize  Int?         // File size in bytes
  filePath  String?      // Local file path (if stored locally)
  mimeType  String?      // MIME type of the file
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  asset     Asset        @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model Depreciation {
  id               String   @id @default(cuid())
  assetId          String
  amount           Float
  date             DateTime
  createdAt        DateTime @default(now())
  depreciationRate Float
  description      String?
  method           String
  salvageValue     Float
  updatedAt        DateTime @updatedAt
  usefulLife       Int
  asset            Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
}

model AssetDepreciation {
  id               String   @id @default(cuid())
  asset            Asset    @relation(fields: [assetId], references: [id])
  assetId          String
  amount           Float
  date             DateTime
  method           String
  usefulLife       Int
  salvageValue     Float
  depreciationRate Float?
  description      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("asset_depreciations")
}

model AssetHistory {
  id        String   @id @default(cuid())
  assetId   String
  field     String
  oldValue  String?
  newValue  String?
  changedAt DateTime @default(now())
  changedBy String?
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
}


enum AssetStatus {
  ACTIVE
  TRANSFERRED
  DISPOSED
  UNDER_MAINTENANCE
}

enum TransferStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
  INSPECTION
}

enum MaintenanceStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MaintenancePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DisposalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum DisposalMethod {
  SALE
  DONATION
  RECYCLE
  SCRAP
}

enum DepreciationMethod {
  STRAIGHT_LINE
  DECLINING_BALANCE
  SUM_OF_YEARS_DIGITS
  UNITS_OF_ACTIVITY
}

enum DocumentType {
  INVOICE
  WARRANTY
  MANUAL
  MAINTENANCE_RECORD
  OTHER
}

enum Role {
  ADMIN
  MANAGER
  USER
}

model LinkedAsset {
  id            String   @id @default(cuid())
  fromAssetId   String
  toAssetId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  fromAsset     Asset    @relation("LinkedFromAsset", fields: [fromAssetId], references: [id], onDelete: Cascade)
  toAsset       Asset    @relation("LinkedToAsset", fields: [toAssetId], references: [id], onDelete: Cascade)

  @@unique([fromAssetId, toAssetId])
  @@index([fromAssetId])
  @@index([toAssetId])
}
model Permission {
  // ...existing fields...
  userPermissions   UserPermission[]
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  rolePermissions RolePermission[]
}

model UserPermission {
  id           String      @id @default(cuid())
  userId       String
  permissionId String
  granted      Boolean     // true = explicitly granted, false = explicitly denied
  user         User        @relation(fields: [userId], references: [id])
  permission   Permission  @relation(fields: [permissionId], references: [id])
  @@unique([userId, permissionId])
}

model RolePermission {
  id           String     @id @default(cuid())
  role         Role
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])
  @@unique([role, permissionId])
}

model CapitalImprovement {
  id                String   @id @default(cuid())
  assetId           String
  description       String
  improvementDate   DateTime
  cost              Float
  usefulLifeMonths  Int?
  depreciationMethod DepreciationMethod?
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
}

enum AuditStatus {
  PENDING
  COMPLETED
  FAILED
  NEEDS_REVIEW
}

enum AuditCondition {
  EXCELLENT
  GOOD
  FAIR
  POOR
  CRITICAL
  MISSING
}

model AssetAudit {
  id                String        @id @default(cuid())
  assetId           String
  auditDate         DateTime
  auditedBy         String
  status            AuditStatus   @default(COMPLETED)
  condition         AuditCondition
  locationVerified  Boolean       @default(true)
  notes             String?
  discrepancies     String?
  discrepancyResolved Boolean     @default(false)
  resolvedDate      DateTime?
  resolvedBy        String?
  resolutionNotes   String?
  photoUrls         String?       // Comma-separated URLs
  nextAuditDate     DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  asset             Asset         @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([auditDate])
  @@index([status])
}
